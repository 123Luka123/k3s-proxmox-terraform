---
- name: Install ArgoCD via Helm
  hosts: k3s_control_plane
  become: yes
  tasks:
    - name: Install community.kubernetes collection
      ansible.builtin.command:
        cmd: ansible-galaxy collection install community.kubernetes
      changed_when: false

    - name: Add ArgoCD Helm repository
      community.kubernetes.helm_repository:
        name: argo
        repo_url: https://argoproj.github.io/argo-helm

    - name: Install ArgoCD
      community.kubernetes.helm:
        name: argocd
        chart_ref: argo/argo-cd
        release_namespace: argocd
        create_namespace: yes
        values:
          server:
            service:
              type: LoadBalancer

    - name: Wait for ArgoCD pods to be ready
      community.kubernetes.k8s_info:
        kind: Pod
        namespace: argocd
        label_selectors:
          - app.kubernetes.io/name=argocd-server
      register: argocd_pods
      until: argocd_pods.resources | length > 0 and argocd_pods.resources | selectattr('status.phase', 'equalto', 'Running') | list | length == argocd_pods.resources | length
      retries: 30
      delay: 10

    - name: Get ArgoCD admin password
      community.kubernetes.k8s:
        namespace: argocd
        kind: Secret
        name: argocd-initial-admin-secret
        state: revealed
      register: argocd_secret

    - name: Display ArgoCD access information
      debug:
        msg: |
          ArgoCD has been installed successfully!
          
          Access ArgoCD UI:
          - URL: http://{{ ansible_host }}:8080 (if using port-forward)
          - Username: admin
          - Password: {{ argocd_secret.resource.data.password | b64decode }}
          
          To access via port-forward:
          kubectl port-forward svc/argocd-server -n argocd 8080:80